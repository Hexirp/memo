# github-trends制作記録

[githb-trends](https://github.com/Hexirp/github-trends)を作った時にどういう風だったのかの記録を書いていく。

## 動機

[日本Haskellユーザーグループ](https://haskell.jp/)のSlackチームをしばらく利用していた。
様々なチャンネルがあり、Stack OverflowにHaskellについての質問が投稿されたことの通知などを読むことが出来る。
しかし、[GitHubのトレンド](https://github.com/trending/haskell)についての通知はなかった。
雑談用チャンネルにそのことを話題に出した。絵文字によってかなり多くのリアクションが得られた。
自分で作るのはめんどくさいのでしばらく放置した。一週間待っても誰もやろうという人がいなかったので自分で作ろうと思った。

## 設計

ぱっと思いついたのは「Stack OverflowにHaskellについての質問が投稿されたことの通知」というものに
使われていたRSSリーダーアプリを使うこと。しかし、GitHubはトレンドについてのRSSを提供していなかった。
次に考えたのはAPIを使って取得することだったが、APIも提供されていなかった。スクレイピングすることにした。
スクレイピングはどうやってやるのか知らなかったので調べた。XPathというものを使えるらしいと分かった。
GitHubのトレンドを取得するためのXPathを調べると`//h3/a/@href`だった。美しい構成のおかげで楽だった。


## 制作

Haskellでスクレイピングをするためにまずはhttpリクエストをしてページを取って来なければならない。
選んだのは[http-conduit](http://hackage.haskell.org/package/http-conduit)というパッケージだった。
conduitという名前が入っていることと[html-conduit](http://hackage.haskell.org/package/html-conduit)という
スクレイピングのためのパッケージと一緒に開発されているためだった。適当な理由だがそんなに実行速度や安全性が
求められていないと考えているためこうした。これらを使ってスクレイピング部分を作った。

フォーマット部分はzipWithを使ったりして簡単に済ませた。難しかったのは投稿部分だった。SlackのAPIを使うときは
ページにアクセスする形だからhttpリクエストをするだけだったが、そのAPIの仕様がよく分からなかった。英語が
読めなかったのが原因なので改善したい。

## 設定

出来たプログラムを一日一回実行したい。TravisCIのcron機能を使い実行することにした。さらに実際の実行部分は
deploy節にした。はまったのは実行権限がないため終了ステータスが127になり続けたことと、ビルドの成果物が
デフォルトではデプロイする前に全てstashされてしまうことだった。また、TravisCIにより提供される環境変数を使って
cronでの実行の場合のみにデプロイするようにすることでコミットしたりマージするたびにSlackのチャンネルに
投稿されるようなことを防止した。
